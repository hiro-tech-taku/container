# Allow switching distro/version of net-snmp at build time
ARG BASE_IMAGE=ubuntu:22.04
FROM ${BASE_IMAGE}

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC

# Install snmptrapd and basic tools
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       snmptrapd snmp bash python3 \
       ca-certificates tzdata procps \
    && rm -rf /var/lib/apt/lists/*

# Create snmp config dir
RUN mkdir -p /etc/snmp /var/run/snmp /var/lib/snmp

# Copy entrypoint
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY udp-fanout.py /usr/local/bin/udp-fanout.py
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/udp-fanout.py

# Listen on UDP/162 by default
EXPOSE 162/udp

# Default envs:
# - SNMP_COMMUNITIES: comma-separated list of allowed communities (default: public)
# - FORWARD_LIST: comma-separated list of targets. Each item format:
#       host[:port][|community]
#   Examples:
#       10.0.0.10            -> forward to 10.0.0.10:162 using incoming community
#       10.0.0.20:1162       -> forward to 10.0.0.20:1162 using incoming community
#       zabbix.local|public2 -> forward to zabbix.local:162 with community "public2"
# - LISTEN_ADDR: address:port for snmptrapd to bind (default: 0.0.0.0:162)
# - DISABLE_AUTH: set to "yes" to accept any community (default: no)
# - OVERWRITE_CONFIG: overwrite mounted /etc/snmp/snmptrapd.conf (default: yes)
# - MIBS: set empty to suppress MIB warnings; override to decode (default: empty)
# - AGENT_PROTO: agentAddress transport (udp|udp4) (default: udp)
# - FORWARD_PROTO: force transport for forward targets (empty|udp|udp4) (default: empty)
# - SNMPTRAPD_DEBUG: add debug tokens to snmptrapd (e.g. -Dforward,trap)
# - SNMPTRAPD_EXTRA_ARGS: extra args passed to snmptrapd
# - FORWARD_BACKEND: snmptrapd|fanout (default: snmptrapd). fanout uses udp-fanout.py to replicate UDP datagrams.
# - FANOUT_VERBOSE: set to 1/true to log fanout activity

# Note:
# - You can switch distro/version via build-arg, e.g.:
#     docker build --build-arg BASE_IMAGE=debian:11-slim -t snmpproxy:debian11 .
#     docker build --build-arg BASE_IMAGE=ubuntu:22.04 -t snmpproxy:jammy .

# Suppress noisy MIB adoption warnings by default (can be overridden at run time)
ENV MIBS=""
ENV PYTHONUNBUFFERED=1

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["snmptrapd", "-f", "-Lo", "-n"]
